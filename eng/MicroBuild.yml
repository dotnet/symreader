resources:
- repo: self
  clean: true
queue:
  name: VSEng-MicroBuildVS2017
  demands: Cmd

steps:
- task: ms-vseng.MicroBuildTasks.30666190-6959-11e5-9f96-f56098202fef.MicroBuildSigningPlugin@1
  inputs:
    signType: real
  condition: and(succeeded(), eq(variables['PB_SignType'], 'real'))

- task: CmdLine@1
  inputs:
    filename: set
    arguments: BUILD

- task: BatchScript@1
  inputs:
    filename: 'eng\common\CIBuild.cmd'
    arguments: '-configuration $(BuildConfiguration)'
    modifyEnvironment: false
    failOnStandardError: true

- task: PublishTestResults@1
  inputs:
    testRunner: XUnit
    testResultsFiles: 'artifacts/$(BuildConfiguration)/TestResults/*.xml'
    mergeTestResults: true
    testRunTitle: 'Unit Tests'
  condition: and(succeeded(), ne(variables['PB_SkipTests'], 'true'))

- task: NuGetPublisher@0
  inputs:
    searchPattern: 'artifacts\$(BuildConfiguration)\packages\*.nupkg'
    connectedServiceName: 'RoslynTools NuGet feed'
    nuGetVersion: 4.0.0.2283
  condition: and(succeeded(), contains(variables['PB_PublishType'], 'myget'))

- task: PublishSymbols@1
  inputs:
    SymbolsPath: '$(DropRoot)\$(TeamName)\$(Build.DefinitionName)\$(Build.BuildNumber)\Symbols'
    SearchPattern: '**/*.+(dll|exe|pdb)'
    SymbolsFolder: '$(Build.SourcesDirectory)\artifacts\$(BuildConfiguration)\SymStore'
    SkipIndexing: true
  enabled: false
  condition: and(succeeded(), contains(variables['PB_PublishType'], 'symbols'))

- task: ms-vscs-artifact.build-tasks.artifactSymbolTask-1.artifactSymbolTask@0
  inputs:
    symbolServiceURI: 'https://microsoft.artifacts.visualstudio.com/DefaultCollection'
    requestName: '$(system.teamProject)/$(Build.DefinitionName)/$(Build.BuildNumber)/$(Build.BuildId)'
    sourcePath: '$(DropRoot)\Roslyn\$(Build.DefinitionName)\$(Build.BuildNumber)\Symbols'
    usePat: false
  enabled: false
  condition: and(succeeded(), contains(variables['PB_PublishType'], 'symbols'))

- task: CopyPublishBuildArtifacts@1
  inputs:
    CopyRoot: '$(Build.SourcesDirectory)'
    Contents: |
     artifacts\$(BuildConfiguration)\bin
     artifacts\$(BuildConfiguration)\log
     artifacts\$(BuildConfiguration)\TestResults
     artifacts\$(BuildConfiguration)\packages
    ArtifactName: '$(Build.BuildNumber)'
    ArtifactType: FilePath
    TargetPath: '$(DropRoot)\Roslyn\$(Build.DefinitionName)'
  condition: and(succeeded(), contains(variables['PB_PublishType'], 'drop'))

- task: ms-vseng.MicroBuildTasks.521a94ea-9e68-468a-8167-6dcf361ea776.MicroBuildCleanup@1
  condition: succeededOrFailed()

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)\MicroBuild\Output'
    ArtifactName: '$(Build.BuildNumber)'
    publishLocation: FilePath
    TargetPath: '$(DropRoot)\Roslyn\$(Build.DefinitionName)'
  condition: and(succeeded(), contains(variables['PB_PublishType'], 'microbuild'))

